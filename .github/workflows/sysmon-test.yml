name: Sysmon Detection Testing

on:
  push:
    paths:
      - 'sysmon/*.xml'
      - 'sysmon/tests/**'
      - '.github/workflows/sysmon-test.yml'
  pull_request:
    paths:
      - 'sysmon/*.xml'
  workflow_dispatch:
    inputs:
      config_type:
        description: 'Config to test (ws, srv, dc, sql, exch, iis, all)'
        required: true
        default: 'all'

jobs:
  validate-xml:
    name: Validate XML Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install xmllint
        run: sudo apt-get update && sudo apt-get install -y libxml2-utils

      - name: Validate Sysmon XML files
        run: |
          echo "Validating Sysmon configuration XML syntax..."
          if ls sysmon/sysmon-*.xml 1> /dev/null 2>&1; then
            for file in sysmon/sysmon-*.xml; do
              echo "Checking $file..."
              xmllint --noout "$file" && echo "  ✓ Valid XML" || exit 1
            done
            echo "All XML files are valid!"
          else
            echo "No XML files found in sysmon/ directory"
            ls -la sysmon/ || echo "sysmon directory not found"
            exit 1
          fi

  test-sysmon-configs:
    name: Test ${{ matrix.config }} Config
    needs: validate-xml
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        config: [ws, srv, dc, sql, exch, iis]

    steps:
      - uses: actions/checkout@v4

      - name: Download Sysmon
        shell: powershell
        run: |
          Write-Host "Downloading Sysmon from Sysinternals..."
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://download.sysinternals.com/files/Sysmon.zip" -OutFile "Sysmon.zip"
          Expand-Archive -Path "Sysmon.zip" -DestinationPath ".\Sysmon" -Force
          Write-Host "Sysmon downloaded successfully"

      - name: Install Sysmon with ${{ matrix.config }} config
        shell: powershell
        run: |
          $configFile = "sysmon\sysmon-${{ matrix.config }}.xml"
          Write-Host "Installing Sysmon with config: $configFile"

          # Install Sysmon - ignore stderr as Sysmon writes info there
          $ErrorActionPreference = 'SilentlyContinue'
          & .\Sysmon\Sysmon64.exe -accepteula -i $configFile *>&1 | Write-Host
          $ErrorActionPreference = 'Continue'

          # Wait for service to start
          Start-Sleep -Seconds 5

          # Verify installation - this is what matters
          $service = Get-Service -Name Sysmon64 -ErrorAction SilentlyContinue
          if ($service -and $service.Status -eq 'Running') {
            Write-Host '[OK] Sysmon installed and running' -ForegroundColor Green
            exit 0
          } else {
            Write-Host '[FAIL] Sysmon installation failed' -ForegroundColor Red
            exit 1
          }

      - name: Run Detection Tests
        id: detection_test
        shell: powershell
        run: |
          Write-Host "Running detection tests for ${{ matrix.config }} configuration..."
          Write-Host "=" * 60

          # Source the test functions
          . .\sysmon\tests\Test-SysmonDetection.ps1 -ConfigType "${{ matrix.config }}" -CI

        continue-on-error: true

      - name: Collect Sysmon Events
        if: always()
        shell: powershell
        run: |
          Write-Host "Collecting Sysmon events generated during tests..."

          $events = Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -MaxEvents 500 -ErrorAction SilentlyContinue

          if ($events) {
            Write-Host "Total events captured: $($events.Count)"
            Write-Host ""

            # Summary by Event ID
            Write-Host "Events by Type:"
            Write-Host "-" * 40
            $events | Group-Object Id | Sort-Object Name | ForEach-Object {
              $eventName = switch ($_.Name) {
                1  { "ProcessCreate" }
                2  { "FileCreateTime" }
                3  { "NetworkConnect" }
                5  { "ProcessTerminate" }
                6  { "DriverLoad" }
                7  { "ImageLoad" }
                8  { "CreateRemoteThread" }
                9  { "RawAccessRead" }
                10 { "ProcessAccess" }
                11 { "FileCreate" }
                12 { "RegistryAddDelete" }
                13 { "RegistryValueSet" }
                14 { "RegistryRename" }
                15 { "FileCreateStreamHash" }
                17 { "PipeCreated" }
                18 { "PipeConnected" }
                19 { "WmiFilterCreate" }
                20 { "WmiConsumerCreate" }
                21 { "WmiBindingCreate" }
                22 { "DnsQuery" }
                23 { "FileDelete" }
                24 { "ClipboardChange" }
                25 { "ProcessTampering" }
                26 { "FileDeleteDetected" }
                default { "Unknown" }
              }
              Write-Host ("  Event {0,2} ({1,-20}): {2}" -f $_.Name, $eventName, $_.Count)
            }

            # Export to artifact
            $events | Select-Object TimeCreated, Id, Message |
              Export-Csv -Path "sysmon-events-${{ matrix.config }}.csv" -NoTypeInformation

          } else {
            Write-Host "No Sysmon events captured - config may be too restrictive"
          }

      - name: Upload Event Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sysmon-events-${{ matrix.config }}
          path: sysmon-events-${{ matrix.config }}.csv
          if-no-files-found: ignore

      - name: Uninstall Sysmon
        if: always()
        shell: powershell
        run: |
          Write-Host 'Cleaning up Sysmon...'
          $svc = Get-Service -Name Sysmon64 -ErrorAction SilentlyContinue
          if ($svc) {
            $ErrorActionPreference = 'SilentlyContinue'
            & .\Sysmon\Sysmon64.exe -u force *>&1 | Out-Null
            Write-Host 'Sysmon uninstalled'
          } else {
            Write-Host 'Sysmon was not installed, skipping cleanup'
          }
          exit 0

  atomic-red-team:
    name: Atomic Red Team - ${{ matrix.config }}
    needs: validate-xml
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        config: [ws, srv, dc, sql, exch, iis]

    steps:
      - uses: actions/checkout@v4

      - name: Download Sysmon
        shell: powershell
        run: |
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://download.sysinternals.com/files/Sysmon.zip" -OutFile "Sysmon.zip"
          Expand-Archive -Path "Sysmon.zip" -DestinationPath ".\Sysmon" -Force

      - name: Install Sysmon
        shell: powershell
        run: |
          $ErrorActionPreference = 'SilentlyContinue'
          & .\Sysmon\Sysmon64.exe -accepteula -i "sysmon\sysmon-${{ matrix.config }}.xml" *>&1 | Write-Host
          Start-Sleep -Seconds 5
          $service = Get-Service -Name Sysmon64 -ErrorAction SilentlyContinue
          if ($service -and $service.Status -eq 'Running') {
            Write-Host '[OK] Sysmon installed'
            exit 0
          } else {
            Write-Host '[FAIL] Sysmon not running'
            exit 1
          }

      - name: Install Atomic Red Team
        shell: powershell
        run: |
          Write-Host "Installing Atomic Red Team..."
          IEX (IWR 'https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1' -UseBasicParsing)
          Install-AtomicRedTeam -getAtomics -Force -ErrorAction SilentlyContinue
          Write-Host "Atomic Red Team installed"

      - name: Run Atomic Tests with Detection Matching
        shell: powershell
        run: |
          Write-Host "Running Atomic Red Team tests with detection matching..."
          Write-Host "Configuration: ${{ matrix.config }}"
          Write-Host ""

          # Import module
          Import-Module "C:\AtomicRedTeam\invoke-atomicredteam\Invoke-AtomicRedTeam.psd1" -Force

          # Techniques per configuration - expanded coverage
          $techniquesByConfig = @{
            "ws" = @(
              "T1059.001", "T1059.003", "T1087.001", "T1057", "T1082",
              "T1547.001", "T1053.005", "T1003.001", "T1218.010", "T1218.011",
              "T1218.005", "T1027", "T1140", "T1055", "T1036"
            )
            "srv" = @(
              "T1059.001", "T1059.003", "T1087.001", "T1087.002", "T1018",
              "T1057", "T1082", "T1547.001", "T1053.005", "T1543.003",
              "T1003.001", "T1070.001", "T1562.001", "T1218.010", "T1218.011"
            )
            "dc" = @(
              "T1059.001", "T1087.002", "T1482", "T1069.002", "T1003.001",
              "T1003.002", "T1003.003", "T1558.003", "T1547.001", "T1484.001",
              "T1018", "T1016", "T1049", "T1033", "T1007"
            )
            "sql" = @(
              "T1059.001", "T1059.003", "T1087.001", "T1005", "T1003.001",
              "T1547.001", "T1543.003", "T1082", "T1057", "T1018"
            )
            "exch" = @(
              "T1059.001", "T1003.001", "T1087.002", "T1070.006", "T1547.001",
              "T1082", "T1057", "T1018", "T1016", "T1049"
            )
            "iis" = @(
              "T1059.001", "T1059.003", "T1003.001", "T1070.006", "T1547.001",
              "T1082", "T1057", "T1018", "T1016", "T1027"
            )
          }

          $config = "${{ matrix.config }}"
          $techniques = $techniquesByConfig[$config]

          Write-Host "Testing $($techniques.Count) techniques for $config configuration"
          Write-Host "=" * 60

          $results = @()

          foreach ($technique in $techniques) {
            Write-Host "`n[*] Testing $technique..." -ForegroundColor Cyan

            # Record start time
            $startTime = Get-Date

            # Get events before test
            $eventsBefore = (Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -MaxEvents 5000 -ErrorAction SilentlyContinue).Count

            try {
              # Execute atomic test
              $ErrorActionPreference = 'SilentlyContinue'
              Invoke-AtomicTest -AtomicTechnique $technique -ErrorAction SilentlyContinue *>&1 | Out-Null

              # Wait for Sysmon to process
              Start-Sleep -Seconds 3

              # Get events after test
              $eventsAfter = Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -MaxEvents 5000 -ErrorAction SilentlyContinue
              $newEvents = $eventsAfter | Where-Object { $_.TimeCreated -ge $startTime }
              $eventCount = $newEvents.Count

              # Get event types generated
              $eventTypes = ($newEvents | Group-Object Id | ForEach-Object { $_.Name }) -join ","

              $detected = $eventCount -gt 0
              $status = if ($detected) { "DETECTED" } else { "NOT_DETECTED" }

              Write-Host "    Events generated: $eventCount [$eventTypes]" -ForegroundColor $(if($detected){'Green'}else{'Yellow'})

              $results += [PSCustomObject]@{
                Technique = $technique
                Config = $config
                Status = $status
                EventCount = $eventCount
                EventTypes = $eventTypes
                Timestamp = $startTime.ToString("yyyy-MM-dd HH:mm:ss")
              }

              # Cleanup after each test
              Invoke-AtomicTest -AtomicTechnique $technique -Cleanup -ErrorAction SilentlyContinue *>&1 | Out-Null
            }
            catch {
              Write-Host "    Error: $($_.Exception.Message)" -ForegroundColor Red
              $results += [PSCustomObject]@{
                Technique = $technique
                Config = $config
                Status = "ERROR"
                EventCount = 0
                EventTypes = ""
                Timestamp = $startTime.ToString("yyyy-MM-dd HH:mm:ss")
              }
            }
          }

          # Summary
          Write-Host "`n" + "=" * 60
          Write-Host "DETECTION COVERAGE SUMMARY - $config"
          Write-Host "=" * 60

          $detected = ($results | Where-Object { $_.Status -eq "DETECTED" }).Count
          $notDetected = ($results | Where-Object { $_.Status -eq "NOT_DETECTED" }).Count
          $errors = ($results | Where-Object { $_.Status -eq "ERROR" }).Count
          $total = $results.Count
          $rate = if ($total -gt 0) { [math]::Round(($detected / $total) * 100, 1) } else { 0 }

          Write-Host "Techniques Tested: $total"
          Write-Host "Detected: $detected" -ForegroundColor Green
          Write-Host "Not Detected: $notDetected" -ForegroundColor Yellow
          Write-Host "Errors: $errors" -ForegroundColor Red
          Write-Host "Detection Rate: $rate%" -ForegroundColor Cyan

          # Export detailed results
          $results | Export-Csv -Path "detection-coverage-${{ matrix.config }}.csv" -NoTypeInformation

          # Create markdown summary
          $mdContent = @"
          # Detection Coverage Report - $config

          **Date:** $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          **Configuration:** $config
          **Detection Rate:** $rate%

          ## Summary
          | Metric | Count |
          |--------|-------|
          | Techniques Tested | $total |
          | Detected | $detected |
          | Not Detected | $notDetected |
          | Errors | $errors |

          ## Detailed Results
          | Technique | Status | Events | Event Types |
          |-----------|--------|--------|-------------|
          "@

          foreach ($r in $results) {
            $mdContent += "`n| $($r.Technique) | $($r.Status) | $($r.EventCount) | $($r.EventTypes) |"
          }

          $mdContent | Out-File -FilePath "detection-report-${{ matrix.config }}.md" -Encoding UTF8

      - name: Collect Detection Results
        if: always()
        shell: powershell
        run: |
          $events = Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -MaxEvents 1000 -ErrorAction SilentlyContinue

          Write-Host "Events captured: $($events.Count)"
          Write-Host ""

          $events | Group-Object Id | Sort-Object Count -Descending | ForEach-Object {
            Write-Host "  Event $($_.Name): $($_.Count)"
          }

          $events | Select-Object TimeCreated, Id, Message |
            Export-Csv -Path "atomic-events-${{ matrix.config }}.csv" -NoTypeInformation

      - name: Upload Detection Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detection-results-${{ matrix.config }}
          path: |
            detection-coverage-${{ matrix.config }}.csv
            detection-report-${{ matrix.config }}.md
            atomic-events-${{ matrix.config }}.csv
          if-no-files-found: ignore

      - name: Cleanup
        if: always()
        shell: powershell
        run: |
          $svc = Get-Service -Name Sysmon64 -ErrorAction SilentlyContinue
          if ($svc) {
            $ErrorActionPreference = 'SilentlyContinue'
            & .\Sysmon\Sysmon64.exe -u force *>&1 | Out-Null
          }
          exit 0

  summary:
    name: Test Summary
    needs: [test-sysmon-configs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results
          pattern: sysmon-events-*
          merge-multiple: true
        continue-on-error: true

      - name: Generate Summary
        run: |
          echo "# Sysmon Detection Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration Test Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Config | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ws | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| srv | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| dc | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| sql | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| exch | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iis | ${{ needs.test-sysmon-configs.result == 'success' && '✅ Passed' || '⚠️ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Event logs from each configuration are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
